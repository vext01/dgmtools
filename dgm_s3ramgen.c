#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <limits.h>

#include "dgm_common.h"
#include "dgm_romlib.h"

HGD_DEBUG_INIT

/* A blank sonic3 RAM image */

#define S3_RAM_SZ		512
unsigned char s3_ram[512] = {
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0x80, 0x00, 0x00, 
  0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 
  0x02, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
  0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x80, 0x00, 0x00, 0x00, 
  0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 
  0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 
  0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 
  0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 
  0x4c, 0x44, 0x2e, 0x5a, 0xd0, 0xd0, 0x80, 0x00, 0x00, 0x00, 0x80, 
  0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 
  0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 
  0x00, 0x00, 0x01, 0x02, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 
  0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x80, 
  0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 
  0x00, 0x01, 0x02, 0x00, 0x80, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 
  0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x00, 0x4c, 0x44, 
  0x2e, 0x5a, 0xd0, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x42, 0x44, 0xed, 
  0x3e, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x42, 0x44, 0xed, 0x3e, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 
  0xd0, 0xd0, 0xd0, 0xd0, 0xd0, 0xd0, };

#define	S3_SAVE_SLOTS_START		0xb4
#define	S3_SAVE_SLOT_LEN		0x8
#define S3_CHECKSUM_OFFSET		0xe6
#define S3_CHECKSUM_START		S3_SAVE_SLOTS_START
#define S3_CHECKSUM_END			S3_CHECKSUM_OFFSET - 2

#define S3_ALL_SAVES_LEN		0x3e
#define S3_SECOND_COPY_OFFSET		0xfa

/* fields within a save slot */
#define S3_SAVE_OFFSET_USED			0x00
#define S3_SAVE_OFFSET_CHARACTER		0x02
#define S3_SAVE_OFFSET_ZONE			0x03
#define S3_SAVE_OFFSET_SPECIAL_STAGE_COUNT	0x04
#define S3_SAVE_OFFSET_EM_COUNT			0x05
#define S3_SAVE_OFFSET_EMS_COLLECTED		0x06 /* bitfield */
#define S3_SAVE_OFFSET_SPECIAL_STAGES_ENTERED	0x07 /* bitfield */

int
main(int argc, char **argv)
{
	/* XXX */
	char			*outfile = "newram";
	uint16_t		 ck = 0;

	s3_test(outfile);

	return (EXIT_SUCCESS);
}


int s3_checksum(unsigned char *ram);

int
s3_test(char *outpath)
{
	struct dgm_file		fs;
	uint16_t		ck = 0;
	int			ret = DGM_FAIL;

	memset(&fs, 0, sizeof(struct dgm_file));
	if ((fs.bytes = calloc(1, S3_RAM_SZ)) == NULL) {
		warn("malloc");
		goto clean;
	}
	memcpy(fs.bytes, s3_ram, S3_RAM_SZ);
	fs.sz = S3_RAM_SZ;

	/* just set a zone */
	printf("DADADA: %x\n", S3_SAVE_SLOTS_START + S3_SAVE_OFFSET_ZONE);

	fs.bytes[S3_SAVE_SLOTS_START + S3_SAVE_OFFSET_ZONE] = (unsigned char) 6;
	fs.bytes[S3_SAVE_SLOTS_START + S3_SAVE_OFFSET_USED] = (unsigned char) 128;
	fs.bytes[S3_CHECKSUM_OFFSET - 2] = (unsigned char) 66;
	fs.bytes[S3_CHECKSUM_OFFSET - 1] = (unsigned char) 68;

	s3_checksum(fs.bytes);

	s3_write_second_copy(fs.bytes);

	printf("CHECKSUM: %02x %02x\n", fs.bytes[S3_CHECKSUM_OFFSET], fs.bytes[S3_CHECKSUM_OFFSET+1]);

	dgm_dump_out_file(outpath, &fs);

	ret = DGM_OK;
clean:

	return (ret);
}

int
s3_write_second_copy(unsigned char *ram)
{
	memcpy(ram + S3_SECOND_COPY_OFFSET, ram + S3_SAVE_SLOTS_START, S3_ALL_SAVES_LEN);
	return (DGM_OK);
}

/*
 * calculates a ram checksum for a given save slot
 */
int
s3_checksum(unsigned char *ram)
{
	int			 ret = DGM_OK;
	unsigned char		*p;
	uint16_t		 offset, len, word = 0;
	int			 ch, cc;
	uint16_t		 cksum;
	unsigned char		 byte1;
	unsigned char		 byte2;

	printf("XXX: %u\n", ram[S3_CHECKSUM_OFFSET - 2]);

	cksum = 0;
	p = ram + S3_CHECKSUM_START;
	while(p <= ram + S3_CHECKSUM_END) {

		word = 0;

		/* read byte 1 */
		word |= *(p++) << 8;
		printf("byte1: %02x\n", ch);

		/* read byte 2 */
		word |= *(p++);
		printf("byte2: %02x\n", ch);

		printf("bytes: %04x\n", word);

		cksum ^= word;

		printf("xor: 0x%04x\n", cksum);

		cc = cksum & 0x1; /* emulate condition code ;) */

		printf("cc: 0x%04x\n", cc);

		//res = (cc << 15) | (res >> 1);
		//res  = (res >> 1) & (cc << 15);
		cksum >>= 1;

		printf("barrel: 0x%04x\n", cksum);

		if (cc) {
			cksum ^= 0x8810;
			printf("^ 8810: 0x%04x\n", cksum);
		}

		printf("end loop %d: 0x%04x\n\n", len, cksum);

	}

	printf("WTF %d: 0x%04x\n\n", len, cksum);

	byte1 = (unsigned char) (cksum >> 8);
	byte2 = (unsigned char) (cksum & 0x00ff);
	printf("0x%02x 0x%02x\n", byte1, byte2);

	/* update cksum field */
	//memcpy(ram + S3_CHECKSUM_OFFSET, cksum, sizeof(uint16_t));

	ram[S3_CHECKSUM_OFFSET] = byte2;
	ram[S3_CHECKSUM_OFFSET + 1] = byte1;

	return (ret);

}
